---
AWSTemplateFormatVersion: 2010-09-09
Transform: AWS::Serverless-2016-10-31

# Legends
# ğŸ“ Use your own values

Globals:
  Function:
    Runtime: python3.11
    Handler: app.lambda_handler

Parameters:
  RootDomain:
    Type: String
    Default: gustavomejia.tech
    Description: "Root domain for the API Gateway"

Resources:
  # ğŸŸ£ External Domain
  MyHostedDomain:
    Type: AWS::Route53::HostedZone
    Properties:
      Name: !Ref RootDomain

  # ğŸ”´ SSL Certificate
  ACMCertificate:
    Type: AWS::CertificateManager::Certificate
    Properties:
      DomainName: !Sub "*.${RootDomain}"
      ValidationMethod: DNS
      DomainValidationOptions:
        - DomainName: !Sub "*.${RootDomain}"
          HostedZoneId: !Ref MyHostedDomain

  # ğŸŸ£ Subdomain Api Gateway http api
  ExampleSubdomainApiGateway:
    Type: AWS::Serverless::HttpApi
    Properties:
      Name: !Sub "${AWS::StackName}-ExampleSubdomain"  # ğŸ“
      StageName: Prod
      Domain:
        DomainName: !Sub "example.${RootDomain}"  # ğŸ“
        CertificateArn: !Ref ACMCertificate
        EndpointConfiguration: REGIONAL
        Route53:
          HostedZoneId: !Ref MyHostedDomain

# ğŸŸ  Layers Libs/Utils/Etc
  LayerLibs:
    Type: AWS::Serverless::LayerVersion
    Properties:
      ContentUri: libs/
      LayerName: !Sub "${AWS::StackName}-Libs"

  # ğŸŸ  Lambda Functions
  ExampleFunction:  # ğŸ“
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/ExampleFunction/  # ğŸ“
      Description: "This is an example. Use it as a reference to create your own function." # ğŸ“
      FunctionName: !Sub "${AWS::StackName}-ExampleFunction"  # ğŸ“
      Policies:
        - AWSLambdaBasicExecutionRole

  ExampleLayer:  # ğŸ“
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/ExampleLayer/  # ğŸ“
      Description: "This is an example. Use it as a reference to create your own function with layers." # ğŸ“
      FunctionName: !Sub "${AWS::StackName}-ExampleLayer"  # ğŸ“
      Layers:
        - !Ref LayerLibs
      Policies:
        - AWSLambdaBasicExecutionRole


  ExampleCronjob:  # ğŸ“
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/ExampleFunction/  # ğŸ“
      Description: "This is an example. Use it as a reference to create your own cronjob." # ğŸ“
      FunctionName: !Sub "${AWS::StackName}-ExampleCronjob"  # ğŸ“
      Policies:
        - AWSLambdaBasicExecutionRole
      Events:
        ScheduledEvent:
          Type: Schedule
          Properties:
            Schedule: cron(0 0 1 1 ? *)  # Se ejecuta el 1 de enero a las 12:00 AM UTC
            Enabled: false

  ExampleApi:  # ğŸ“
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/ExampleFunction/  # ğŸ“
      Description: "This is an example. Use it as a reference to create your own endpoint." # ğŸ“
      FunctionName: !Sub "${AWS::StackName}-ExampleApi"  # ğŸ“
      Policies:
        - AWSLambdaBasicExecutionRole
      Events:
        ExampleAPIEvent:
          Type: HttpApi
          Properties:
            ApiId: !Ref ExampleSubdomainApiGateway
            Method: GET
            Path: /example  # ğŸ“

  HelloWorldCamicase:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/HelloWorldCamicase/
      Description: "Hello world of Camicase" # ğŸ“
      FunctionName: !Sub "${AWS::StackName}-HelloWorldCamicase"  # ğŸ“
      Policies:
        - AWSLambdaBasicExecutionRole

Outputs:
  HostedZoneNameServers:
    Description: "Please copy the name servers below to your DNS provider"
    Value: !Join [",", !GetAtt MyHostedDomain.NameServers]
  HostedZoneArn:
    Description: "Please use this Id to create records"
    Value: !GetAtt MyHostedDomain.Id
  StackInfo:
    Value: !Sub "Stack name: ${AWS::StackName}, Id: ${AWS::StackId}"
...
